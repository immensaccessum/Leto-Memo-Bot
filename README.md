
# Leto Memo Bot — README

Инлайн-бот для подготовки «поста с кнопками» и публикации в каналах через `@ИмяБота <КОД>`. Работает на домашнем сервере по long polling. Входящие порты не требуются. Создание и публикация доступны только пользователям из allow-list.

## Возможности

*   Черновик поста: текст или фото с подписью.
*   Гибкая сетка кнопок в несколько рядов:
    *   **URL** — переход по ссылке.
    *   **Alert** — модальное окно с текстом.
    *   **Share** — кнопка для быстрой пересылки этого же поста.
*   Превью перед сохранением.
*   Публикация по инлайн-коду.
*   Редактирование сохранённого поста.
*   Список и удаление своих постов.
*   Хранение в SQLite. Медиа — по `file_id`. Клавиатура формируется из 2D-массива.

## Архитектура

*   Node.js + [grammY](https://grammy.dev/) для Telegram Bot API.
*   SQLite для хранения постов и структуры кнопок.
*   Long polling на домашнем сервере.
*   Allow-list для ограничения использования.
*   Кнопки задаются компактной «формулой» в сообщении, которая парсится в 2D-массив и превращается в `InlineKeyboard`.

### Потоки

1.  **Создание:** В ЛС с ботом → `/new` → отправка текста/фото → отправка «формулы кнопок» → `/preview` → `/save` → бот выдаёт код.
2.  **Публикация:** В канале → набор `@ИмяБота <КОД>` → выбор результата из инлайн-меню → отправка → закрепление.

## Требования

*   Node.js ≥ 18
*   NPM
*   SQLite3
*   Токен бота и включённый **Inline Mode** в BotFather.

## Установка

```bash
# Установка зависимостей в каталоге проекта
npm i grammy dotenv sqlite3 sqlite nanoid
```

Создайте файл `.env`:

```
BOT_TOKEN=123456:ABC...          # токен вашего бота
ALLOWED_IDS=744387869,111111111  # TG ID пользователей через запятую
```

`package.json` должен содержать:

```json
{
  "type": "module",
  "scripts": { "start": "node index.js" }
}
```

Запуск:

```bash
npm start
```

## Использование

### Базовый сценарий

1.  В ЛС с ботом:
    ```
    /new
    ```
    Пришлите текст поста или фото с подписью.

2.  Следующим сообщением пришлите «формулу кнопок» (см. ниже).

3.  Проверьте результат:
    ```
    /preview
    ```

4.  Сохраните пост:
    ```
    /save
    ```
    Бот пришлёт вам финальный вид поста и следом — код для вставки вида `@ИмяБота <КОД>`.

5.  **Публикация в канале:** в поле ввода наберите `@ИмяБота <КОД>`, выберите пост, отправьте и закрепите.

### Команды

*   `/start` — помощь и описание ограничений.
*   `/new` — создать или сбросить черновик.
*   `/preview` — показать текущий черновик.
*   `/save` — сохранить черновик и получить код для публикации.
*   `/edit <КОД>` — загрузить опубликованный пост в черновик для правки.
*   `/list` — список ваших сохранённых постов.
*   `/delete <КОД>` — удалить пост.

## «Формула» кнопок

Кнопки описываются одним сообщением в специальном формате:
*   Каждый **ряд** кнопок — это отдельная строка в сообщении.
*   Кнопки в одном ряду разделяются символом `|`.
*   Формат кнопки: `[Текст на кнопке](Данные)`.

#### Поддерживаемые данные:

*   **URL:** `http(s)://...` или `tg://...`
    `[Сайт](https://copy65.ru)`
*   **Alert:** `alert:Ваш текст`
    `[Помощь](alert:Это краткая подсказка)`
*   **Share:** `share`
    `[Поделиться](share)`

#### Пример формулы для 2-рядной клавиатуры:

```
[Сайт](https://copy65.ru) | [Помощь](alert:Короткая подсказка)
[Распространить этот пост](share)
```

## Редактирование

1.  Введите `/edit <КОД>` в ЛС с ботом.
2.  Пост будет загружен в черновик.
3.  Отправьте новый текст/фото и/или новую формулу кнопок.
4.  Выполните `/save`.
5.  Код поста останется прежним, но его содержимое обновится.

## Модель данных (SQLite)

Таблица `posts`:
*   `code` — публичный код поста (уникальный).
*   `owner_id` — TG ID владельца.
*   `status` — `'draft'` или `'published'`.
*   `media_type` — `'text'` или `'photo'`.
*   `file_id` — Telegram `file_id` для фото.
*   `caption` — текст или подпись к фото.
*   `buttons` — JSON-представление 2D-массива кнопок.

## Безопасность

*   Жёсткий allow-list (`ALLOWED_IDS`) на все операции, включая инлайн-вставку.
*   Валидация ссылок: разрешены только `http(s)://` и `tg://`.
*   Медиа не скачиваются на сервер, используется `file_id`.

## Лимиты Telegram

*   **Длина сообщения:** Текст поста и сообщение с "формулой" кнопок не могут превышать **4096 символов**.
*   **Подпись к фото:** ≤ 1024 символов.
*   **Количество кнопок:** ≤ 100 на один пост.
*   **`callback_data`:** Данные для `alert`-кнопок ограничены 64 байтами. Наш формат `a:КОД:ID` использует их с большим запасом.

## Резервное копирование

```bash
sqlite3 bot.db ".backup 'backup-$(date +%F).db'"
```

## Сервисный запуск (systemd / PM2)

Примеры конфигураций для запуска бота в фоновом режиме находятся в предыдущих версиях этого документа. Они стандартны и применимы к финальной версии кода.